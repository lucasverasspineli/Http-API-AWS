# Projeto com passo a passo para Criar um AWS SAM
>**OBS :** Todos os processos ser√£o feito no pr√≥prio console da AWS, lembrando que o console da AWS est√° em constante atualiza√ß√µes, podendo mudar o layout por√©m os conceitos permanecem.

## Finalidade do projeto

Esse projeto tem um intuito de orientar na cria√ß√£o de um Serverless Application Model (SAM) ou seja, um aplicativo sem uso de um servidor. Onde explicar√° de forma mais pr√°tica e detalhada poss√≠vel a usar os servi√ßos da AWS Lambda, DynamoDB para cria√ß√£o do banco e dados e o servi√ßo API Gateway para o gerenciamento da api realizando CRUD, de uma forma mais pr√°tica e sequ√™ncial poss√≠vel.

### Para esse projeto ser√° necess√°rio o uso dos seguintes servi√ßos da AWS :
---
* DynamoDB
* Lambda
* API Gateway
---
### Conceitos dos Servi√ßos AWS:

### DynamoDB      

![Icon-DynamoDB](.\img\icon-DynamoDb.png) 
O Amazon DynamoDB √© um banco de dados NoSQL que suporta modelos de dados de valores-chave e de documentos. Os desenvolvedores podem usar o Amazon DynamoDB para criar aplica√ß√µes modernas sem servidor, que podem come√ßar pequenas e serem dimensionadas globalmente para oferecer suporte a petabytes e dezenas de milh√µes de solicita√ß√µes de leitura e grava√ß√£o por segundo.

### Lambda

![Lambda](.\img\Lambda_resized.png) 
O AWS Lambda √© um servi√ßo computacional sem servidor que executa c√≥digo em resposta a eventos e gerencia automaticamente os recursos computacionais subjacentes para voc√™. Esses eventos podem incluir mudan√ßas no estado ou uma atualiza√ß√£o, como um usu√°rio colocando um item em um carrinho de compras de um site de com√©rcio eletr√¥nico por exemplo. 

### API Gateway

![Lambda](.\img\API-Gateway_resized.png) 
O Amazon API Gateway √© um servi√ßo da AWS para cria√ß√£o, publica√ß√£o, manuten√ß√£o, monitoramento e prote√ß√£o de APIs REST e WebSocket em qualquer escala. Os desenvolvedores de API podem criar APIs que acessem a AWS ou outros web services, bem como dados armazenados na Nuvem AWS.


## Inicializando o banco de dados n√£o relacional com o servi√ßo DynamoDB


**I. Pesquisar o servi√ßo no console da AWS**

![Console-aws](.\img\Console-AWS-DynamoDB.png) 
1. Buscar o servi√ßo no console.  

2. Escolher o servi√ßo

3. N.Virginia √© a regi√£o que ser√° hospedado este servi√ßo. 

> Todos os servi√ßos ser√£o feito na regi√£o da N.Virginia

![Get Started-DynamoDB](.\img\GetStart-Dynamodb.png) 

**II. Cria√ß√£o da tabela**

1. Nomear um nome para a tabela.

2. Partition Key e o campo da chave prim√°ria, onde se pode nomear este campo com nome **id** do tipo **String**.
> üîë  N√£o existe chave com auto-incremento na tabela n√£o relacional
3. Clicar no bot√£o Create table

![Get Started-DynamoDB](.\img\Create-Table-DynamoDB.png)

**III. Acessar o menu lateral Tables**  

Clicar na tabela tbl-person

![Get Started-DynamoDB](.\img\acess-table-DynamoDB.png)

**IV Clique no bot√£o Explore table items**

Detalhamento sobre a tabela. ![Get Started-DynamoDB](img\Explore-Table-items.png)

Caso queira pode nomear uma tag para tabela, seja criando um pr√≥prio nome ou com tag's j√° definidas como Aplica√ß√£o, Homologa√ß√£o.
Em Items returned est√° vazio pois n√£o foi criado nenhum campo na tabela.

![Get Started-DynamoDB](.\img\items-returned-DynamoDb.png)

## Inicializando o servi√ßo Lambda

**I. Pesquisar o servi√ßo no console da AWS**

1. Buscar o servi√ßo no console.  
2. Escolher o servi√ßo
3. N.Virginia √© a regi√£o que ser√° hospedado este servi√ßo. 

![Get Started-DynamoDB](.\img\console-aws-Lambda.png)

**II. Clicar no bot√£o Create Function**

![Get Started-DynamoDB](.\img\Lambda-functions.png)

**III. Criando uma Fun√ß√£o Lambda**

1. Nomeando uma fun√ß√£o Lambda
2. Escolhendo uma linguagem de programa√ß√£o e sua vers√£o, para criar o c√≥digo da fun√ß√£o com os endpoints na linguagem escolhida.

![Get Started-DynamoDB](.\img\Create-Lambda.png)

**IV. Criando e configurando uma Role**

Para criar uma Role com policy da pr√≥pria AWS:

**V. Selecionar a op√ß√£o**

  Create a new role from AWS policy template

- [ ] Create a new role with Lambda permissions 
- [ ] Use an existing role

 ‚úÖ Create a new role from AWS policy template

2. Criando um nome para Role
3. Colocando uma Policy padr√£o **Simple microservice permissions**
4. Clicar em Create Function

![Get Started-DynamoDB](.\img\lambda-roles.png)

**VI. Criar um c√≥digo para o CRUD em JS**

Esse c√≥digo √© na linguagem que foi escolhida na hora da cria√ß√£o da fun√ß√£o Lambda.

<details>
<summary>
C√≥digo fonte da fun√ß√£o Lambda
</summary>

```
const AWS = require("aws-sdk");

const dynamo = new AWS.DynamoDB.DocumentClient();

exports.handler = async (event, context) => {
  let body;
  let statusCode = 200;
  const headers = {
    "Content-Type": "application/json"
  };

  try {
    switch (event.routeKey) {
      case "DELETE /items/{id}":
        await dynamo
          .delete({
            TableName: "tbl-person",
            Key: {
              id: event.pathParameters.id
            }
          })
          .promise();
        body = `Deleted item ${event.pathParameters.id}`;
        break;
      case "GET /items/{id}":
        body = await dynamo
          .get({
            TableName: "tbl-person",
            Key: {
              id: event.pathParameters.id
            }
          })
          .promise();
        break;
      case "GET /items":
        body = await dynamo.scan({ TableName: "tbl-person" }).promise();
        break;
      case "PUT /items":
        let requestJSON = JSON.parse(event.body);
        await dynamo
          .put({
            TableName: "tbl-person",
            Item: {
              id: requestJSON.id,
              name: requestJSON.name,
              cpf: requestJSON.cpf,
              sexo: requestJSON.sexo,
              altura: requestJSON.altura,
              nacionalidade: requestJSON.nacionalidade
            }
          })
          .promise();
        body = `Put item ${requestJSON.id}`;
        break;
      default:
        throw new Error(`Unsupported route: "${event.routeKey}"`);
    }
  } catch (err) {
    statusCode = 400;
    body = err.message;
  } finally {
    body = JSON.stringify(body);
  }

  return {
    statusCode,
    body,
    headers
  };
};
```
</details>

Ap√≥s o c√≥digo clicar no Deploy.

---- 

Criando uma vari√°vel AWS que recebe os m√≥dulos de servi√ßos da AWS, com o "aws-sdk".

```const AWS = require("aws-sdk");```

Acessando o banco de dados do DynamoDB e colocando na vari√°vel dynamo.

```const dynamo = new AWS.DynamoDB.DocumentClient();```

Exportando a fun√ß√£o com um m√©todo assincrono 

```exports.handler = async (event, context) => {...}```

## Inicializando o servi√ßo API Gateway

**I. Pesquisar o servi√ßo no console da AWS**

![Get Started-API-Gateway](.\img\API-Gateway-search.png)

**II. Escolher o tipo de API**

Nesse exemplo ser√° uma HTTP API.

A API sera respons√°vel para disponibilzar um endpoint de HTTP para a fun√ß√£o do lambda que foi criada.
![Get Started-API-Gateway](.\img\HTTP_API-Gateway.png)

**III. Criando a API**

Criando um nome para API

```http-api-person```

Ap√≥s isso clicar no Next.      

![Get Started-API-Gateway](.\img\name-api-gateway.png)

**IV. Criando rotas**

>As rota ser√£o inseridas depois

Clicar em Next.

![Get Started-API-Gateway](.\img\config-routes.png)

**V. Define stages**

Clicar em Next.

![Get Started-API-Gateway](.\img\define-status-api_Gateway.png)

**VI. Review da API**

![Get Started-API-Gateway](.\img\Review-Api-Gateway.png)

**VII. Definindo as rotas**

Para definir as rotas tem que ir no menu lateral clicar em Develop e depois em  Routes.

Na Api que voc√™ criou clicar em Create.

Para criar cada rota, no caso todas as rotas do CRUD.

![Get Started-API-Gateway](.\img\Routes-api-gateway.png)

### IX. Cria√ß√£o de rotas Http

**Criando a rota de Delete**

Escolhendo o verbo Http espec√≠fico e mapeando o caminho do mesmo jeito que est√° no fun√ß√£o Lambda.

![Get Started-API-Gateway](.\img\route-Delete.png)

**Criando uma rota GET obtendo um ID**

Mapeando o m√©todo GET para obter um objeto espec√≠fico pelo ID.

![Get Started-API-Gateway](.\img\route-GetById.png)

**Criando uma rota GET obtendo uma Lista de Objetos**

Mapeando o m√©todo GET objtendo todos os objetos da tabela tbl-Person.

![Get Started-API-Gateway](.\img\Get-All.png)

**Criando uma rota PUT**

![Get Started-API-Gateway](.\img\PUT-items.png)

**Mostrando todas as rotas da API**

![Get Started-API-Gateway](.\img\Routes-all-api-person.png)

## Fazendo toda a comunica√ß√£o entre API, fun√ß√£o Lambda e o banco DynamoDB

>Tem que realizar a integra√ß√£o da comunica√ß√£o entre as rotas do Api-Gateway para a rotas da fun√ß√£o Lambda, para poder realizar o CRUD com o banco de dados.

![Lambda](.\img\fluxo-aws-SAM.png) 

Clicando no Integrations no menu lateral, e criando um gerenciamento para a integra√ß√£o.

![Get Started-API-Gateway](.\img\Integrations-routes.png)

Criando um tipo de integra√ß√£o, escolhendo uma integra√ß√£o Lambda Function.

![Get Started-API-Gateway](.\img\create-integration.png)

**Detalhes de Integra√ß√£o**

Associando uma fun√ß√£o lambda com a integra√ß√£o da API que foi criada.

escolhendo a regi√£o.
Depois clicar em Next.

![Get Started-API-Gateway](.\img\integrations-details.png)

### Integra√ß√£o dos m√©todos Http 

>Associando todos os caminhos dos verbos Http

**O m√©todo Put Integrado**

Clicando no Attach integrations to routes.

Clicando no m√©todo PUT, e escolhendo a fun√ß√£o lambda para integrar o mapeamento.

![Get Started-API-Gateway](.\img\integration-route-PUT.png)

M√©todo integrado e mapeado com a fun√ß√£o lambda

![Get Started-API-Gateway](.\img\PUT-aws_lambda.png)

Fazer o mesmo processo com todos os outros m√©todos.

Todos os m√©todos mapeados e integrados, ficam assim :

 ![Get Started-API-Gateway](.\img\review-integrations.png)

Para acessar a URL da API, tem que ir no menu lateral e clicar em API: nome-sua-API

![Get Started-API-Gateway](.\img\URL-Api_Gateway.png)

## ‚ö° Os testes foram feitos com o Software Postman ‚ö°

* PUT

Adicionando um objeto na tabela tbl-person.
>Colocando no Postman a URL da API/caminho dos m√©todos, que est√° na API Gateway de cada verbo Http.
Todos os dados est√£o no arquivo **Dados_tbl-person-JSON.**

![Get Started-API-Gateway](.\img\Postman-PUT.png)

* GET

Obtendo um registro da tabela tbl-Person pelo ID.

![Get Started-API-Gateway](.\img\Postman-GET-ID.png)

* GET-ALL

Listando todos os dados na tabela tbl-person, ap√≥s adicionar os objetos na tabela.

![Get Started-API-Gateway](.\img\Postman-GET-ALL.png)

* DELETE

Deletando um objeto da tabela tbl-person, pelo seu ID.

![Get Started-API-Gateway](.\img\Postman-DELETE.png)

## Demonstrando os dados na tabela DynamoDB ![Get Started-API-Gateway](.\img\database.png)

Demonstrando a tabela tbl-person sendo povoada, pelo Postman.

![Get Started-API-Gateway](.\img\intems-returned-Dynamo.png)

Com isso todo o sistema est√° finalizado.
